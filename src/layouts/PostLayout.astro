---
import BaseLayout from "./BaseLayout.astro";
import { getTopicColor } from "../utils/colors.js";
import TableOfContents from "../components/TableOfContents.astro";

interface Props {
  frontmatter: {
    title: string;
    description?: string;
    date?: string;
    useKatex?: boolean;
    useD3?: boolean;
    scripts?: string[];
    category?: string;
    showToc?: boolean;
  };
  post?: {
    id?: string;
    collection?: string;
    slug?: string;
  };
  headings?: Array<{
    depth: number;
    slug: string;
    text: string;
  }>;
}

const { frontmatter, post, headings = [] } = Astro.props as Props;
const {
  title,
  description,
  useKatex = false,
  useD3 = false,
  showToc = false,
} = frontmatter;

let documentTitle = title;
if (post?.collection === "git" && post?.slug) {
  documentTitle = `${post.slug}.git`;
} else if (
  (post?.collection === "gists" || post?.collection === "gist") &&
  post?.slug
) {
  documentTitle = `${post.slug}`;
}

const topicColor = getTopicColor(post?.collection);
---

<BaseLayout title={documentTitle} description={description}>
  <Fragment slot="head">
    <link rel="stylesheet" href="/styles/posts.css" />
    <link rel="stylesheet" href="/styles/graph.css" />
    {
      useKatex && (
        <link
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css"
          integrity="sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP"
          crossorigin="anonymous"
        />
      )
    }
    {useD3 && <script src="https://d3js.org/d3.v7.min.js" is:inline />}
    <slot name="head" />
  </Fragment>

  <div
    class="post-wrapper"
    style={topicColor ? `--topic-color: ${topicColor};` : ""}
  >
    {
      showToc && headings.length > 0 && (
        <aside class="toc-column">
          <TableOfContents headings={headings} />
        </aside>
      )
    }

    <div class="post-container">
      <header class="post-header">
        <h1 class="post-title">{title}</h1>
        {frontmatter.date && <p class="post-meta">{frontmatter.date}</p>}
      </header>

      <article class="post-article">
        <slot />
      </article>
    </div>
  </div>

  <Fragment slot="scripts">
    <script src="/scripts/index.js" is:inline></script>
    <script src="/scripts/centerKatex.js" is:inline></script>
    {frontmatter.scripts?.map((src) => <script src={src} is:inline />)}
    <slot name="scripts" />
  </Fragment>
</BaseLayout>
